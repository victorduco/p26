# Video State Persistence

## Описание

Компонент `CaseVideo.vue` теперь сохраняет состояние видео **только при переходе на внутренние страницы кейсов** (story) и восстанавливает его при возврате назад на главную страницу.

## Ключевая особенность

⚠️ **Состояние сохраняется ТОЛЬКО при переходе на страницу story** (`/story/one`, `/story/two`, `/story/three`)

При любых других сценариях (перезагрузка страницы, переход по прямой ссылке, навигация с других страниц) все видео начинаются заново.

## Что сохраняется

При клике на ссылку story (через кнопку в финальном оверлее или через NavigationChevron) сохраняется:

- Текущее время воспроизведения (`currentTime`)
- Статус воспроизведения (играет/пауза)
- Настройка звука (включен/выключен)
- Состояние компонента (начато воспроизведение, показан финальный оверлей)
- Временная метка сохранения

## Как это работает

### Сохранение состояния

1. **Триггер сохранения**:

   - При клике на "Open Story" в финальном оверлее видео
   - При клике на NavigationChevron в заголовке кейса
   - Вызывается метод `handleStoryLinkClick()` перед навигацией

2. **Хранилище**:
   - Используется `sessionStorage` с ключом: `video-state-{videoSrc}`
   - Данные сохраняются в момент клика на ссылку story

### Восстановление состояния

1. **При монтировании компонента** (`onMounted`):

   - Проверяет наличие сохраненного состояния в `sessionStorage`
   - Ждет загрузки метаданных видео
   - Восстанавливает позицию, звук и состояние воспроизведения
   - Проверяет актуальность данных (не старше 5 минут)

2. **Что восстанавливается**:

   - Текущая позиция видео
   - Настройка звука
   - Визуальное состояние (visible/hidden)
   - Финальный оверлей (если видео закончилось)
   - Автоматически продолжает воспроизведение, если видео играло

3. **Умное поведение**:
   - При восстановлении состояния видео НЕ запускается автоматически через IntersectionObserver
   - Предотвращает конфликты между автоматическим воспроизведением и восстановленным состоянием

### Очистка состояния

Состояние автоматически очищается:

1. **При монтировании MainPage** (`MainPage.vue`):

   - Если пользователь НЕ пришел со страницы story
   - Очищаются все сохраненные состояния видео
   - Проверяется через `route.meta.skipNavIntro`

2. **При нажатии кнопок**:

   - "Restart" во время воспроизведения
   - "Replay" в финальном оверлее

3. **Автоматически**:
   - При обнаружении устаревших данных (старше 5 минут)
   - При закрытии вкладки (sessionStorage)

## Архитектура решения

### Компоненты

1. **CaseVideo.vue**:

   - `saveVideoState()` - сохраняет текущее состояние
   - `restoreVideoState()` - восстанавливает сохраненное состояние
   - `clearVideoState()` - очищает сохраненное состояние
   - `handleStoryLinkClick()` - вызывается при клике на story ссылку
   - `isComingFromStory()` - проверяет наличие сохраненного состояния

2. **CaseItem.vue**:

   - `handleNavigationClick()` - обработчик клика на NavigationChevron
   - Вызывает `caseVideo.handleStoryLinkClick()` перед навигацией

3. **MainPage.vue**:

   - `onMounted()` - очищает все состояния видео, если не пришли со story
   - Проверяет `route.meta.skipNavIntro` для определения источника навигации

4. **router/index.js**:
   - Устанавливает `meta.skipNavIntro` при возврате со story на главную
   - Используется для определения направления навигации

### Поток данных

```
Клик на story ссылку
    ↓
handleStoryLinkClick()
    ↓
saveVideoState() → sessionStorage
    ↓
Навигация на /story/*
    ↓
Возврат назад (browser back или NavigationChevron)
    ↓
router.beforeEach устанавливает meta.skipNavIntro = true
    ↓
MainPage onMounted → НЕ очищает состояния
    ↓
CaseVideo onMounted → isComingFromStory() === true
    ↓
restoreVideoState() ← sessionStorage
```

## Технические детали

### Структура сохраненных данных

```javascript
{
  currentTime: number,        // Текущая позиция видео в секундах
  isPlaying: boolean,         // true если видео воспроизводится
  isMuted: boolean,           // true если звук выключен
  hasStartedPlayback: boolean, // true если воспроизведение было начато
  showFinalOverlay: boolean,  // true если показан финальный оверлей
  timestamp: number           // Unix timestamp сохранения
}
```

### Ключи хранения

```
video-state-{videoSrc}
```

Где `{videoSrc}` - полный URL видео файла

## Преимущества

1. **Лучший UX** - пользователь не теряет прогресс просмотра при переходе на story
2. **Естественное поведение** - свежий опыт при перезагрузке или прямом переходе
3. **Умная очистка** - автоматически удаляет устаревшие данные
4. **Изолированность** - каждое видео имеет свой ключ хранения
5. **Предсказуемость** - ясные правила когда сохраняется, а когда нет

## Ограничения

- Состояние сохраняется только в рамках одной сессии браузера (sessionStorage)
- Данные старше 5 минут считаются устаревшими и удаляются
- Сохранение работает ТОЛЬКО при переходе на страницы story
- Не работает при перезагрузке страницы или прямых переходах
